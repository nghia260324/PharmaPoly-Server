<style>
    .product-type-item {
        border: 1px solid #ddd;
        /* Viền cho item */
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
    }

    .product-type-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .low-stock {
        color: #dc3545;
        font-weight: 600;
    }

    .product-card:hover {
        transform: translateY(-2px);
        transition: all 0.2s;
    }

    .badge-status-active {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-status-paused {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-status-discontinued {
        background-color: #f8d7da;
        color: #721c24;
    }

    .update-status-item {
        cursor: pointer;
    }
</style>

<div class="container mt-3">
    <div class="product-header mb-4 p-3 bg-light rounded">
        <div class="d-flex justify-content-between align-items-center">
            <span class="h5 mb-0"><span data-lang="product">Products</span></span>
            {{!-- <button type="button" class="btn btn-success" data-bs-toggle="modal"
                data-bs-target="#addProductModal">
                <i class="bi bi-plus-circle"></i> <span data-lang="add_new_product">Add New Product</span>
            </button> --}}
            <a href="/products/add" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> <span data-lang="add_new_product">Add New Product</span>
            </a>
        </div>
    </div>

    <div class="row g-2 align-items-center mb-3">
        <div class="col-md-4">
            <input type="text" id="searchProduct" class="form-control" placeholder="Tìm theo tên sản phẩm"
                value="{{search}}">
        </div>
        <div class="col-md-4">
            <select id="sortProducts" class="form-select">
                <option value="name_asc" {{#ifCond sort "name_asc" }}selected{{/ifCond}}>Tên A-Z</option>
                <option value="name_desc" {{#ifCond sort "name_desc" }}selected{{/ifCond}}>Tên Z-A</option>
                {{!-- <option value="price_asc" {{#ifCond sort "price_asc" }}selected{{/ifCond}}>Giá thấp đến cao</option>
                <option value="price_desc" {{#ifCond sort "price_desc" }}selected{{/ifCond}}>Giá cao đến thấp</option> --}}
            </select>
        </div>
        <div class="col-md-2">
            <button id="btnSearchProduct" class="btn btn-primary w-100">Tìm kiếm</button>
        </div>
    </div>

    <div class="card md-4">
        <div class="card-body">
            <div id="productList" class="product-list row g-3">
                {{#unless products.length}}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-search display-6 d-block mb-2"></i>
                    <h5>Không tìm thấy sản phẩm nào</h5>
                    <p>Hãy thử điều chỉnh từ khóa tìm kiếm hoặc bộ lọc.</p>
                </div>
                {{/unless}}
                {{#each products}}
                <div class="col-12">
                    <div class="card product-card h-100" data-id="{{this._id}}">
                        <div class="card-body">
                            <div class="row g-3 align-items-start justify-content-between">
                                <!-- Image Section -->
                                <div class="col-12 col-md-2 col-lg-1" style="min-width: 132px;">
                                    <img src="{{this.image}}" class="img-fluid rounded-3"
                                        style="aspect-ratio: 1/1; object-fit: cover;" alt="{{this.name}}">
                                </div>

                                <!-- Product Info -->
                                <div class="col-12 col-md-8 h-100">
                                    <div class="d-flex flex-column h-100">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0 fw-semibold me-2">{{this.name}}</h6>
                                            {{!-- <span class="badge {{getProductStatusClass this.status}} fs-10">
                                                <i class="bi {{getStatusIcon this.status}} me-1"></i>
                                                {{formatProductStatus this.status}}
                                            </span> --}}


                                            {{#if (eq this.status "discontinued")}}
                                            <span class="badge {{getProductStatusClass this.status}} fs-10">
                                                <i class="bi {{getStatusIcon this.status}} me-1"></i>
                                                {{formatProductStatus this.status}}
                                            </span>
                                            {{else}}
                                            <div class="dropdown">
                                                <button
                                                    class="badge {{getProductStatusClass this.status}} fs-10 dropdown-toggle border-0"
                                                    type="button" data-bs-toggle="dropdown" aria-expanded="false"
                                                    style="cursor: pointer;">
                                                    <i class="bi {{getStatusIcon this.status}} me-1"></i>
                                                    {{formatProductStatus this.status}}
                                                </button>
                                                <ul class="dropdown-menu">
                                                    {{#if (eq this.status "not_started")}}
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="active">
                                                            Hoạt động (bắt đầu bán)</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="paused">
                                                            Tạm ngừng bán (có thể mở lại)</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="discontinued">
                                                            Ngừng bán vĩnh viễn</a></li>
                                                    {{/if}}

                                                    {{#if (eq this.status "active")}}
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="paused">
                                                            Tạm ngừng bán</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="discontinued">
                                                            Ngừng bán vĩnh viễn</a></li>
                                                    {{/if}}

                                                    {{#if (eq this.status "paused")}}
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="active">
                                                            Mở bán lại</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="discontinued">
                                                            Ngừng bán vĩnh viễn</a></li>
                                                    {{/if}}

                                                    {{#if (eq this.status "out_of_stock")}}
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="active">
                                                            Còn hàng, mở bán</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="paused">
                                                            Tạm ngừng</a></li>
                                                    <li><a class="dropdown-item update-status-item"
                                                            data-id="{{this._id}}" data-status="discontinued">
                                                            Ngừng bán vĩnh viễn</a></li>
                                                    {{/if}}
                                                </ul>
                                            </div>
                                            {{/if}}

                                        </div>

                                        <div class="d-flex flex-wrap">
                                            {{#each this.product_types}}
                                            <div class="col-12 col-md-4 col-lg-4 p-2">
                                                <div class="border rounded p-2 bg-light small position-relative">
                                                    <div class="d-flex justify-content-between">
                                                        <span class="text-muted">Loại:</span>
                                                        <span class="fw-semibold">{{this.product_type_id.name}}</span>
                                                    </div>

                                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                                        <span class="text-muted">Giá bán: ({{formatPrice this.price}}VND)</span>
                                                        <input step="100" type="number"
                                                            class="form-control form-control-sm update-price"
                                                            data-product-id="{{../_id}}"
                                                            data-type-id="{{this.product_type_id._id}}"
                                                            value="{{this.price}}" data-original="{{this.price}}"
                                                            style="width: 80px;">
                                                    </div>

                                                    <div class="d-flex justify-content-between mt-1">
                                                        <span class="text-muted">Tồn kho:</span>
                                                        <span><i
                                                                class="bi bi-box-seam me-1"></i>{{this.stock_quantity}}</span>
                                                    </div>

                                                    <button
                                                        class="btn btn-sm btn-outline-primary btn-update-price mt-2 w-100 d-none"
                                                        data-product-id="{{../_id}}"
                                                        data-type-id="{{this.product_type_id._id}}">
                                                        <i class="bi bi-save me-1"></i>Cập nhật giá
                                                    </button>
                                                </div>
                                            </div>
                                            {{/each}}
                                        </div>



                                    </div>
                                </div>

                                <div class="col-12 col-md-2 col-lg-2 h-100">
                                    <div class="d-grid gap-2">
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-sm btn-outline-secondary view-product-details"
                                                data-id="{{this._id}}" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </button>

                                            <button class="btn btn-sm btn-outline-warning edit-product"
                                                data-id="{{this._id}}" title="Chỉnh sửa">
                                                <i class="bi bi-pencil"></i>
                                            </button>

                                            {{#if (neq this.status "not_started")}}
                                            <button class="btn btn-sm btn-outline-secondary position-relative pe-none"
                                                data-bs-toggle="tooltip" data-bs-placement="top"
                                                title="Sản phẩm đang ở trạng thái {{formatProductStatus this.status}} - Không thể xóa">
                                                <span class="opacity-50 d-inline-flex align-items-center">
                                                    <i class="bi bi-trash"></i>
                                                </span>
                                                <span class="position-absolute top-0 start-100 translate-middle">
                                                    <i class="bi bi-lock-fill text-danger small"></i>
                                                </span>
                                            </button>
                                            {{else}}
                                            <button class="btn btn-sm btn-outline-danger delete-product"
                                                data-id="{{this._id}}" title="Xóa sản phẩm">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {{/if}}

                                        </div>

                                        <button class="btn btn-sm btn-success import-stock" data-id="{{this._id}}">
                                            <i class="bi bi-plus-circle me-1"></i>Nhập hàng
                                        </button>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Info Footer -->
                        <div class="card-footer bg-transparent small">
                            <div class="d-flex justify-content-between text-muted">
                                <span>ID: {{this._id}}</span>
                                <span>Cập nhật: {{formatDate this.updated_at}}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
        <nav>
            <ul class="pagination justify-content-center">
                {{#if (gt currentPage 1)}}
                <li class="page-item">
                    <a class="page-link" href="?page={{sub currentPage 1}}&limit={{limit}}">Trang trước</a>
                </li>
                {{/if}}

                <li class="page-item disabled">
                    <span class="page-link">Trang {{currentPage}} / {{totalPages}}</span>
                </li>

                {{#if (lt currentPage totalPages)}}
                <li class="page-item">
                    <a class="page-link" href="?page={{add currentPage 1}}&limit={{limit}}">Trang sau</a>
                </li>
                {{/if}}
            </ul>
        </nav>
    </div>
</div>



<!-- Modal Add Product -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel"><span data-lang="add_new_product">Add New
                        Product</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Product Name -->
                            <div class="mb-3">
                                <label for="productName" class="form-label"><span data-lang="product_name">Product
                                        Name</span></label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>

                            <!-- Category -->
                            <div class="mb-3">
                                <label for="productCategory" class="form-label"><span
                                        data-lang="category">Category</span></label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="" selected disabled><span data-lang="select_category">Select
                                            Category</span></option>
                                    {{#each categories}}
                                    <option value="{{this._id}}">{{this.name}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <!-- Brand -->
                            <div class="mb-3">
                                <label for="productBrand" class="form-label"><span
                                        data-lang="brand">Brand</span></label>
                                <select class="form-select" id="productBrand" required>
                                    <option value="" selected disabled><span data-lang="select_brand">Select
                                            Brand</span></option>
                                    {{#each brands}}
                                    <option value="{{this._id}}">{{this.name}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="productTypes" class="form-label"><span data-lang="product_types">Product
                                        Types</span></label>
                                <select class="form-select" id="productTypes" multiple required>
                                    <option value="" disabled><span data-lang="select_product_types">Select Product
                                            Types</span></option>
                                    {{#each productTypes}}
                                    <option value="{{this._id}}">{{this.name}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <!-- Price for each selected Product Type -->
                            <div id="productTypePriceContainer" class="mb-3">
                                <!-- Here we will dynamically generate price fields for each selected Product Type -->
                            </div>

                            <!-- Price -->

                            {{!-- <!-- Average Rating -->
                            <div class="mb-3" style="pointer-events: none; cursor: default; user-select: none;">
                                <label for="averageRating" class="form-label"><span data-lang="average_rating">Average
                                        Rating</span></label>
                                <input type="number" class="form-control bg-secondary text-white" id="averageRating"
                                    value="0" readonly>
                            </div>

                            <!-- Review Count -->
                            <div class="mb-3" style="pointer-events: none; cursor: default; user-select: none;">
                                <label for="reviewCount" class="form-label"><span data-lang="review_count">Review
                                        Count</span></label>
                                <input type="number" class="form-control bg-secondary text-white" id="reviewCount"
                                    value="0" readonly>
                            </div> --}}

                            <!-- Short Description -->
                            <div class="mb-3">
                                <label for="shortDescription" class="form-label"><span
                                        data-lang="short_description">Short Description</span></label>
                                <textarea class="form-control" id="productShortDescription" rows="3"
                                    data-lang-placeholder="enter_a_short_description"
                                    placeholder="Enter a short description"></textarea>
                            </div>

                            <!-- Specification -->
                            <div class="mb-3">
                                <label for="specification" class="form-label"><span
                                        data-lang="specification">Specification</span></label>
                                <input type="text" class="form-control" id="productSpecification"
                                    data-lang-placeholder="enter_packaging_details"
                                    placeholder="Enter packaging details (e.g., Box of 10 blisters x 10 tablets)">
                            </div>

                            <!-- Manufacturer -->
                            <div class="mb-3">
                                <label for="manufacturer" class="form-label"><span
                                        data-lang="manufacturer">Manufacturer</span></label>
                                <input type="text" class="form-control" id="productManufacturer"
                                    data-lang-placeholder="enter_the_manufacturer's_name"
                                    placeholder="Enter the manufacturer's name">
                            </div>

                            <!-- Country of Origin -->
                            <div class="mb-3">
                                <label for="originCountry" class="form-label"><span
                                        data-lang="country_of_origin">Country of Origin</span></label>
                                <input type="text" class="form-control" id="productOriginCountry"
                                    data-lang-placeholder="enter_the_country_of_origin"
                                    placeholder="Enter the country of origin">
                            </div>
                        </div>

                        <!-- Column Left -->
                        <div class="col-md-6">
                            <!-- Sections -->
                            <div class="mb-3" id="addSectionContainer">
                                <label class="form-label"><span data-lang="sections">Sections</span></label>
                            </div>

                            <!-- Add Section Button -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary" id="addSectionBtn">
                                    <i class="bi bi-plus-circle"></i><span data-lang="add_section">Add Section</span>
                                </button>
                            </div>


                            <!-- Add Image Button -->
                            <div class="mb-3">
                                <label class="form-label"><span data-lang="product_images">Product Images</span></label>

                                <input type="file" id="productImages" accept="image/*" multiple hidden>
                            </div>

                            <!-- Image Preview Section -->
                            <div id="addImagePreview" class="gap-3">
                                <div style="display: inline-block;">
                                    <button type="button"
                                        class="btn btn-outline-primary d-flex align-items-center justify-content-center"
                                        id="addImageBtn"
                                        style="width: 100%; aspect-ratio: 1/1; font-size: 24px; border-style: dashed; border-width: 2px;">
                                        <i class="bi bi-image-alt fs-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100 mt-4"><span data-lang="add_product">Add
                            Product</span></button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel"><span data-lang="confirm_deletion">Confirm
                        Deletion</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><span data-lang="are_you_sure">Are you sure you want to delete this product?</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span
                        data-lang="cancel">Cancel</span></button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn"><span
                        data-lang="delete">Delete</span></button>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap Toast Notification -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastMessage" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <span data-lang="product_added_successfully!">Product added successfully!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p id="loadingMessage" class="mt-3"><span data-lang="Loading...">Đang xử lý...</span></p>
        </div>
    </div>
</div>

<div class="modal fade" id="statusConfirmModal" tabindex="-1" aria-labelledby="statusConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusConfirmModalLabel">Xác nhận cập nhật trạng thái</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p id="statusConfirmMessage">Bạn có chắc chắn muốn cập nhật trạng thái sản phẩm?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="statusConfirmUpdateBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xác nhận Cập nhật Giá -->
<div class="modal fade" id="priceConfirmModal" tabindex="-1" aria-labelledby="priceConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceConfirmModalLabel">Xác nhận cập nhật giá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p id="priceConfirmMessage">Bạn có chắc chắn muốn cập nhật giá sản phẩm thành mới không?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="priceConfirmUpdateBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.view-product-details').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();

                const productId = this.getAttribute('data-id');

                window.location.href = `/products/${productId}/detail`;
            });
        });


        let pendingProductId = null;
        let pendingProductTypeId = null;
        let pendingNewPrice = null;
        let pendingNewStatus = null;

        document.addEventListener('click', function (e) {
            const target = e.target.closest('.update-status-item');
            if (!target) return;

            pendingProductId = target.dataset.id;
            pendingNewStatus = target.dataset.status;

            const confirmMessage = `Bạn có chắc chắn muốn cập nhật trạng thái sản phẩm thành "${target.textContent}" không?`;
            document.getElementById('statusConfirmMessage').innerText = confirmMessage;

            const confirmModal = new bootstrap.Modal(document.getElementById('statusConfirmModal'));
            confirmModal.show();
        });

        document.getElementById('statusConfirmUpdateBtn').addEventListener('click', async function () {
            if (!pendingProductId || !pendingNewStatus) return;

            const confirmModalEl = document.getElementById('statusConfirmModal');
            const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
            confirmModal.hide();

            try {
                showLoadingModal('edit');

                const res = await fetch(`/products/edit/${pendingProductId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: pendingNewStatus })
                });

                const data = await res.json();
                hideLoadingModal();

                if (res.ok) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Cập nhật thất bại!', 'danger');
                }
            } catch (err) {
                console.error(err);
                hideLoadingModal();
                showToast('Có lỗi xảy ra khi cập nhật trạng thái.', 'danger');
            }
        });


        document.querySelectorAll('.update-price').forEach(input => {
            input.addEventListener('input', (e) => {
                const currentValue = parseFloat(e.target.value);
                const originalValue = parseFloat(e.target.dataset.original);
                const container = e.target.closest('.border');
                const button = container.querySelector('.btn-update-price');

                if (currentValue !== originalValue) {
                    button.classList.remove('d-none');
                } else {
                    button.classList.add('d-none');
                }
            });
        });
        document.addEventListener('click', function (e) {
            const target = e.target.closest('.btn-update-price');
            if (!target) return;

            pendingProductId = target.dataset.productId;
            pendingProductTypeId = target.dataset.typeId;
            const input = target.closest('.border').querySelector('.update-price');
            pendingNewPrice = parseFloat(input.value);

            const confirmMessage = `Bạn có chắc chắn muốn cập nhật giá sản phẩm thành "${formatPrice(pendingNewPrice)} VND" không?`;
            document.getElementById('priceConfirmMessage').innerText = confirmMessage;

            const confirmModal = new bootstrap.Modal(document.getElementById('priceConfirmModal'));
            confirmModal.show();
        });
        document.getElementById('priceConfirmUpdateBtn').addEventListener('click', async function () {
            if (!pendingProductId || !pendingProductTypeId || !pendingNewPrice) return;

            const confirmModalEl = document.getElementById('priceConfirmModal');
            const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
            confirmModal.hide();

            try {
                showLoadingModal('edit');

                const res = await fetch(`/products/edit/${pendingProductId}/product-types/${pendingProductTypeId}/price`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price: pendingNewPrice }),
                });

                const data = await res.json();
                hideLoadingModal();

                if (res.ok) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Cập nhật thất bại!', 'danger');
                }
            } catch (err) {
                console.error(err);
                hideLoadingModal();
                showToast('Có lỗi xảy ra khi cập nhật giá.', 'danger');
            }
        });



        const formatPrice = (price) => {
            if (typeof price !== "number") {
                return "N/A";
            }
            return price.toLocaleString("vi-VN");
        };









        document.querySelectorAll('.import-stock').forEach(button => {
            button.addEventListener('click', function (event) {
                const productId = event.target.closest('button').dataset.id;

                window.location.href = `products/${productId}/import-stock`;
            });
        });


        document.getElementById("btnSearchProduct").addEventListener("click", function () {
            const search = document.getElementById("searchProduct").value.trim();
            const sort = document.getElementById("sortProducts").value;

            window.location.href = `?page=1&limit=10&search=${search}&sort=${sort}`;
        });




        function showToast(message, type) {
            const toastEl = document.getElementById("toastMessage");
            toastEl.classList.remove("bg-success", "bg-danger");
            toastEl.classList.add(`bg-${type}`);
            toastEl.querySelector(".toast-body").innerText = message;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function deleteProduct(button) {
            const productCard = button.closest('.product-card');
            const productId = productCard.getAttribute("data-id");

            if (!productId) {
                showToast("Product ID is required!", "danger");
                return;
            }

            const modal = new bootstrap.Modal(deleteConfirmationModal);
            modal.show();

            document.getElementById("confirmDeleteBtn").onclick = function () {
                modal.hide();

                showLoadingModal("delete");

                fetch(`/products/delete/${productId}`, {
                    method: "DELETE"
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 200) {
                            showToast(result.message, "success");
                            //productCard.remove();
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showToast(result.message, "danger");
                        }
                    })
                    .catch(error => {
                        showToast("An error occurred!", "danger");
                        hideLoadingModal();
                        modal.hide();
                    })
                    .finally(() => {
                        hideLoadingModal();
                    });
            };
        }
        function showLoadingModal(action) {
            let message = "Đang xử lý...";
            if (action === "add") message = "Đang thêm sản phẩm...";
            if (action === "edit") message = "Đang cập nhật sản phẩm...";
            if (action === "delete") message = "Đang xóa sản phẩm...";

            document.getElementById("loadingMessage").innerText = message;
            const modal = new bootstrap.Modal(document.getElementById("loadingModal"));
            modal.show();
        }

        function hideLoadingModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById("loadingModal"));
            if (modal) modal.hide();
        }

        document.querySelectorAll('.edit-product').forEach(button => {
            button.addEventListener('click', function () {
                //editProduct(button);
                const productId = button.getAttribute('data-id');
                if (productId) {
                    window.location.href = `/products/${productId}/edit`;
                }
            });
        });
        document.querySelectorAll('.delete-product').forEach(button => {
            button.addEventListener('click', function () {
                deleteProduct(button);
            });
        });

    });
</script>