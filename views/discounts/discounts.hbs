<style>
    .selected-items-container {
        display: flex;
        flex-wrap: nowrap;
        gap: 5px;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        min-height: 80px;
        max-height: 150px;
        overflow-y: auto;
        background-color: #fff;
    }

    .selected-item {
        display: flex;
        align-items: center;
        background-color: #e9ecef;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 14px;
        max-width: 240px;
        height: 32px;
        overflow: hidden;
    }

    .selected-item span {
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .selected-item .remove-item {
        flex-shrink: 0;
        margin-left: 8px;
        cursor: pointer;
        color: red;
        font-weight: bold;
    }
</style>

<div class="container mt-4">
    <div class="brand-header mb-4 p-3 bg-light rounded">
        <div class="d-flex justify-content-between align-items-center">
            <span class="h5 mb-0"><span data-lang="discounts">Discounts</span></span>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDiscountModal">
                <i class="bi bi-plus-circle"></i> <span data-lang="add_new_discount">Add New Discount</span>
            </button>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>#</th>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Start Date</th>
                <th>Expiry Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="discountTableBody">
            {{#each discounts}}
            <tr>
                <td>{{addOne @index}}</td>
                <td>{{this.code}}</td>
                <td>{{#if (eq this.type "percent")}}Percentage{{else}}Fixed Amount{{/if}}</td>
                <td>{{#if (eq this.type "percent")}}{{this.value}}%{{else}}{{this.value}} VND{{/if}}</td>
                <td class="date-format">{{this.start_date}}</td>
                <td class="date-format">{{this.end_date}}</td>
                <td class="status-column" data-start="{{this.start_date}}" data-end="{{this.end_date}}"></td>
                <td>
                    {{!-- <button class="btn btn-warning btn-sm"
                        onclick="editDiscount('{{this._id}}', '{{this.code}}', '{{this.type}}', '{{this.value}}', '{{this.start_date}}', '{{this.end_date}}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteDiscount('{{this._id}}')">Delete</button>
                    --}}
                    <button class="btn btn-info btn-sm">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-warning btn-sm"
                        onclick="editDiscount('{{this._id}}', '{{this.code}}', '{{this.type}}', '{{this.value}}', '{{this.start_date}}', '{{this.end_date}}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteDiscount('{{this._id}}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>

            </tr>
            {{/each}}
        </tbody>
    </table>
</div>




<div class="modal fade" id="addDiscountModal" tabindex="-1" aria-labelledby="addDiscountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDiscountModalLabel">Create New Discount</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="discountForm">
                    <div class="mb-3">
                        <label for="discountCode" class="form-label">Discount Code</label>
                        <input type="text" class="form-control" id="discountCode" required>
                    </div>

                    <div class="mb-3">
                        <label for="appliesTo" class="form-label">Applies To</label>
                        <div class="d-flex">
                            <select class="form-select me-2" id="appliesTo" required>
                                {{#each appliesTo}}
                                <option value="{{this}}">{{formatDiscountField this "applies_to"}}</option>
                                {{/each}}
                            </select>
                            <button type="button" id="selectTargetBtn"
                                class="btn btn-outline-secondary d-none">Select</button>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="targetIdsContainer">
                        <label class="form-label">Selected Items</label>
                        <div id="selectedItemsContainer" class="selected-items-container"></div>
                    </div>


                    <div class="mb-3">
                        <label for="discountType" class="form-label">Discount Type</label>
                        <select class="form-select" id="discountType" required>
                            {{#each discountTypes}}
                            <option value="{{this}}">{{formatDiscountField this "type"}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="discountValue" class="form-label">Discount Value</label>
                        <input type="number" class="form-control" id="discountValue" required>
                    </div>

                    <div class="mb-3">
                        <label for="minOrderValue" class="form-label">Minimum Order Value</label>
                        <input type="number" class="form-control" id="minOrderValue">
                    </div>

                    <div class="mb-3 d-none" id="maxDiscountContainer">
                        <label for="maxDiscount" class="form-label">Maximum Discount</label>
                        <input type="number" class="form-control" id="maxDiscount">
                    </div>


                    <div class="row mb-3">
                        <div class="col">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Stackable</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="stackable">
                            <label class="form-check-label" for="stackable">Can be used with other codes</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="minOrderValue" class="form-label">Minimum Order Value</label>
                        <input type="number" class="form-control" id="minOrderValue">
                    </div>

                    <div class="mb-3 d-none" id="maxDiscountContainer">
                        <label for="maxDiscount" class="form-label">Maximum Discount</label>
                        <input type="number" class="form-control" id="maxDiscount">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Usage Limit</label>
                        <div class="d-flex">
                            <select class="form-select me-2 w-50" id="usageLimitType">
                                <option value="unlimited">Unlimited</option>
                                <option value="limited">Limited</option>
                            </select>
                            <input type="number" class="form-control d-none w-50" id="usageLimitValue"
                                placeholder="Enter limit">
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>







<script>

    document.addEventListener("DOMContentLoaded", function () {

        const discountType = document.getElementById("discountType");
        const maxDiscountContainer = document.getElementById("maxDiscountContainer");

        discountType.addEventListener("change", function () {
            if (this.value === "percent") {
                maxDiscountContainer.classList.remove("d-none");
            } else {
                maxDiscountContainer.classList.add("d-none");
            }
        });









        const appliesToSelect = document.getElementById("appliesTo");
        const selectTargetBtn = document.getElementById("selectTargetBtn");
        const targetIdsContainer = document.getElementById("targetIdsContainer");
        const selectedItemsContainer = document.getElementById("selectedItemsContainer");

        let selectedItems = [];

        appliesToSelect.addEventListener("change", function () {
            const value = appliesToSelect.value;
            if (["product", "category", "brand"].includes(value)) {
                selectTargetBtn.classList.remove("d-none");
                targetIdsContainer.classList.remove("d-none");
            } else {
                selectTargetBtn.classList.add("d-none");
                targetIdsContainer.classList.add("d-none");
                selectedItems = [];
                renderSelectedItems();
            }
        });

        selectTargetBtn.addEventListener("click", function () {
            // Ở đây bạn có thể mở modal hoặc danh sách để chọn item, mình tạm dùng prompt để demo
            const selectedNames = prompt("Enter selected item names (comma separated):", "");
            if (selectedNames) {
                selectedItems = selectedNames.split(",").map(name => name.trim());
                renderSelectedItems();
            }
        });

        function renderSelectedItems() {
            selectedItemsContainer.innerHTML = "";
            selectedItems.forEach((item, index) => {
                const itemElement = document.createElement("div");
                itemElement.classList.add("selected-item");
                itemElement.innerHTML = `
                <span title="${item}">${item}</span>
                <span class="remove-item" data-index="${index}">&times;</span>
            `;
                selectedItemsContainer.appendChild(itemElement);
            });

            // Xử lý sự kiện xóa item
            document.querySelectorAll(".remove-item").forEach(button => {
                button.addEventListener("click", function () {
                    const index = this.getAttribute("data-index");
                    selectedItems.splice(index, 1);
                    renderSelectedItems();
                });
            });
        }







        document.querySelectorAll(".date-format").forEach(element => {
            const date = new Date(element.innerText);
            element.innerText = date.toLocaleDateString("vi-VN");
        });

        document.querySelectorAll(".status-column").forEach(element => {
            const startDate = new Date(element.dataset.start);
            const endDate = new Date(element.dataset.end);
            const today = new Date();

            let statusText = "Expired";
            let statusClass = "text-danger";

            if (today >= startDate && today <= endDate) {
                statusText = "Active";
                statusClass = "text-success";
            } else if (today < startDate) {
                statusText = "Upcoming";
                statusClass = "text-warning";
            }

            element.innerHTML = `<span class="${statusClass} fw-bold">${statusText}</span>`;
        });

    });

</script>