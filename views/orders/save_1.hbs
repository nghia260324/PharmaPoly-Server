<div class="container mt-4">
    <a href="/orders" class="btn btn-outline-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>


    <h3 class="mb-4">Chi Ti·∫øt ƒê∆°n H√†ng #{{order.order_code}}</h3>

    <!-- Th√¥ng tin ƒë∆°n h√†ng -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Th√¥ng Tin ƒê∆°n H√†ng</h5>
            <br>
            <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> {{order.to_name}}</p>
            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{order.to_phone}}</p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> {{order.to_address}}, {{userAddress.ward.WardName}},
                {{userAddress.district.DistrictName}}, {{userAddress.province.ProvinceName}}</p>

            <p class="date-format" data-created-at="{{order.created_at}}"><strong>Ng√†y ƒë·∫∑t:</strong>
                {{order.created_at}}
            </p>
            <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> <span class="badge bg-primary">{{order.payment_method}}</span>
            </p>
            <p><strong>T·ªïng ti·ªÅn:</strong> {{order.total_price}} VND</p>
            {{!-- <p><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge bg-warning">{{order.status}}</span></p> --}}
            <p><strong>Tr·∫°ng th√°i:</strong>
                <span class="status-badge bg-warning">{{getStatusText order.status}}</span>
            </p>

            <div class="mt-3">
                <label for="orderStatus" class="form-label">C·∫≠p nh·∫≠t tr·∫°ng th√°i:</label>
                <select class="form-select w-50" id="orderStatus">
                    {{#if (eq order.status "pending")}}
                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="canceled">ƒê√£ h·ªßy</option>
                    {{else if (eq order.status "confirmed")}}
                    <option value="ready_to_pick">Chu·∫©n b·ªã giao</option>
                    <option value="canceled">ƒê√£ h·ªßy</option>
                    {{else if (eq order.status "ready_to_pick")}}
                    <option value="delivering">ƒêang giao h√†ng</option>
                    <option value="canceled">ƒê√£ h·ªßy</option>
                    {{/if}}
                </select>



                <button id="btnUpdateStatus" class="btn btn-success mt-3">L∆∞u tr·∫°ng th√°i</button>
            </div>
        </div>
    </div>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Danh S√°ch S·∫£n Ph·∫©m</h5>
            <table class="table table-bordered mt-3">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>H√¨nh ·∫£nh</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√°</th>
                        <th>T·ªïng</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each orderItems}}
                    <tr>
                        <td>{{addOne @index}}</td>
                        <td><img src="{{this.image_url}}" alt="H√¨nh ·∫£nh s·∫£n ph·∫©m" width="50"></td>
                        <td>{{this.product_id.name}}</td>
                        <td>{{this.quantity}}</td>
                        <td>{{this.price}} VND</td>
                        <td>{{multiply this.quantity this.price}} VND</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>

        </div>
    </div>
</div>
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastMessage" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">
                <!-- Message will be inserted here -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>
<!-- Modal x√°c nh·∫≠n c·∫≠p nh·∫≠t tr·∫°ng th√°i -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">X√°c nh·∫≠n c·∫≠p nh·∫≠t tr·∫°ng th√°i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh <strong id="selectedStatusText"></strong>
                kh√¥ng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmUpdateStatus">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
            </div>
            <p class="mt-2">ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i, vui l√≤ng ch·ªù...</p>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        formatDates();

        const btnUpdateStatus = document.getElementById("btnUpdateStatus");
        const selectStatus = document.getElementById("orderStatus");
        const confirmUpdateStatus = document.getElementById("confirmUpdateStatus");
        const selectedStatusText = document.getElementById("selectedStatusText");
        const orderId = "{{order._id}}";
        const orderStatus = "{{order.status}}";

        const lockedStatuses = ["delivered", "canceled", "delivery_fail", "returned", "return_fail"];

        if (lockedStatuses.includes(orderStatus)) {
            btnUpdateStatus.disabled = true;
            selectStatus.disabled = true;
        }

        let selectedStatus = "";

        btnUpdateStatus.addEventListener("click", function () {
            selectedStatus = selectStatus.value;
            selectedStatusText.textContent = selectStatus.options[selectStatus.selectedIndex].text;
            const modal = new bootstrap.Modal(document.getElementById("confirmModal"));
            modal.show();
        });

        confirmUpdateStatus.addEventListener("click", async function () {
            const apiConfig = {
                confirmed: { url: `/orders/${orderId}/confirm`, method: "PUT", body: {} },
                ready_to_pick: { url: `/orders/${orderId}/send-to-ghn`, method: "PUT", body: {} },
                canceled: { url: `/orders/${orderId}/cancel`, method: "POST", body: {} },
            };

            if (!apiConfig[selectedStatus]) {
                showToast("Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá!", "bg-danger");
                return;
            }

            const { url, method, body } = apiConfig[selectedStatus];

            const loadingModal = new bootstrap.Modal(document.getElementById("loadingModal"));
            loadingModal.show();


            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body),
                });

                if (!response.ok) {
                    throw new Error("C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i");
                }

                const result = await response.json();
                showToast(result.message || "C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng", "bg-success");
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                showToast(error.message, "bg-danger");
            } finally {
                loadingModal.hide();
            }
        });



        const socket = io();
        socket.on("new_order", function (order) {
            showToast("üì¢ B·∫°n v·ª´a c√≥ m·ªôt ƒë∆°n h√†ng m·ªõi!", "bg-info");
        });











    });

    function formatDates() {
        document.querySelectorAll(".date-format").forEach(element => {
            const timestamp = element.dataset.createdAt;
            if (timestamp) {
                const date = new Date(timestamp);
                const formattedDate = date.toLocaleString("vi-VN", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: false
                });
                element.innerHTML = `<strong>Ng√†y ƒë·∫∑t:</strong> ${formattedDate}`;
            }
        });
    }
    function showToast(message, bgClass = "bg-success") {
        const toastElement = document.getElementById("toastMessage");
        const toastBody = document.getElementById("toastBody");

        toastBody.textContent = message;
        toastElement.classList.remove("bg-success", "bg-danger");
        toastElement.classList.add(bgClass);

        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }

</script>