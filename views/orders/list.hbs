<div class="container mt-5">
    <div class="card product-header mb-4 p-3 bg-light rounded">
        {{!-- <div class="d-flex justify-content-between align-items-center">
            <span class="h5 mb-0"><span data-lang="orders">Orders</span></span>
            <div class="row">
                <form id="searchForm" class="row">
                    <div class="col-md-3">
                        <input type="text" id="searchOrder" name="search" class="form-control"
                            placeholder="T√¨m theo m√£ ƒë∆°n ho·∫∑c t√™n kh√°ch h√†ng" value="{{filters.search}}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label d-block invisible">T√¨m</label>
                        <button type="submit" class="btn btn-primary w-100">T√¨m ki·∫øm</button>
                    </div>
                </form>
            </div>
            <button class="btn btn-outline-secondary" id="toggleFilter">
                <i class="bi bi-funnel"></i> B·ªô l·ªçc
            </button>
        </div> --}}
        <div class="row align-items-center">
            <span class="col-md-1"><span data-lang="orders">Orders</span></span>
            <div class="col-md-6">
                <form id="searchForm" class="row">
                    <div class="col-md-8">
                        <input type="text" id="searchOrder" name="search" class="form-control"
                            placeholder="T√¨m theo m√£ ƒë∆°n ho·∫∑c t√™n kh√°ch h√†ng" value="{{filters.search}}">
                    </div>
                    <div class="col-md-3">
                        {{!-- <label class="form-label d-block invisible">T√¨m</label> --}}
                        <button type="submit" class="btn btn-primary w-100">T√¨m ki·∫øm</button>
                    </div>
                </form>
            </div>
            <div class="col-md-3"></div>
            <div class="col-md-2 row align-items-end">
                <button class="btn btn-outline-secondary" id="toggleFilter">
                    <i class="bi bi-funnel"></i> B·ªô l·ªçc
                </button>
            </div>
        </div>
    </div>
    <div class="card mb-4" id="filterCard" style="display: none;">
        <div class="card-body">
            <form class="g-2" id="filterForm">
                <div class="row align-items-end">
                    {{!-- <div class="col-md-3">
                        <label for="searchOrder" class="form-label">T√¨m ki·∫øm theo m√£ ƒë∆°n ho·∫∑c t√™n kh√°ch h√†ng</label>
                        <input type="text" id="searchOrder" class="form-control"
                            placeholder="T√¨m theo m√£ ƒë∆°n ho·∫∑c t√™n kh√°ch h√†ng" value="{{filters.search}}">
                    </div> --}}

                    <div class="col-md-2">
                        <label for="sortOrders" class="form-label">S·∫Øp x·∫øp theo</label>
                        <select id="sortOrders" class="form-select" name="sort">
                            <option value="created_at_desc" {{#ifCond filters.sort "created_at_desc"
                                }}selected{{/ifCond}}>
                                M·ªõi nh·∫•t
                            </option>
                            <option value="created_at_asc" {{#ifCond filters.sort "created_at_asc"
                                }}selected{{/ifCond}}>C≈©
                                nh·∫•t
                            </option>
                            <option value="total_price_desc" {{#ifCond filters.sort "total_price_desc"
                                }}selected{{/ifCond}}>T·ªïng ti·ªÅn cao nh·∫•t
                            </option>
                            <option value="total_price_asc" {{#ifCond filters.sort "total_price_asc"
                                }}selected{{/ifCond}}>
                                T·ªïng ti·ªÅn th·∫•p nh·∫•t
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterPaymentMethod" class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                        <select id="filterPaymentMethod" class="form-select" name="payment_method">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="COD" {{#ifCond filters.payment_method "COD" }}selected{{/ifCond}}>COD
                            </option>
                            <option value="ONLINE" {{#ifCond filters.payment_method "ONLINE" }}selected{{/ifCond}}>
                                ONLINE
                            </option>
                        </select>
                    </div>

                </div>

                <div class="row align-items-end mt-3">
                    <div class="col-md-2">
                        <label for="filterStatus" class="form-label">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
                        <select id="filterStatus" class="form-select" name="status">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="pending" {{#ifCond filters.status "pending" }}selected{{/ifCond}}>Ch·ªù x√°c
                                nh·∫≠n
                            </option>
                            <option value="confirmed" {{#ifCond filters.status "confirmed" }}selected{{/ifCond}}>ƒê√£ x√°c
                                nh·∫≠n
                            </option>
                            <option value="ready_to_pick" {{#ifCond filters.status "ready_to_pick"
                                }}selected{{/ifCond}}>Ch·ªù
                                l·∫•y
                                h√†ng (GHN)</option>
                            <option value="picking" {{#ifCond filters.status "picking" }}selected{{/ifCond}}>GHN ƒëang
                                l·∫•y
                                h√†ng
                            </option>
                            <option value="picked" {{#ifCond filters.status "picked" }}selected{{/ifCond}}>GHN ƒë√£ l·∫•y
                                h√†ng
                            </option>
                            <option value="delivering" {{#ifCond filters.status "delivering" }}selected{{/ifCond}}>ƒêang
                                giao
                                h√†ng
                            </option>
                            <option value="money_collect_delivering" {{#ifCond filters.status "money_collect_delivering"
                                }}selected{{/ifCond}}>ƒêang giao (COD)</option>
                            <option value="delivered" {{#ifCond filters.status "delivered" }}selected{{/ifCond}}>Giao
                                th√†nh
                                c√¥ng
                            </option>
                            <option value="delivery_fail" {{#ifCond filters.status "delivery_fail"
                                }}selected{{/ifCond}}>
                                Giao th·∫•t
                                b·∫°i</option>
                            <option value="waiting_to_return" {{#ifCond filters.status "waiting_to_return"
                                }}selected{{/ifCond}}>Ch·ªù
                                ho√†n h√†ng</option>
                            <option value="return" {{#ifCond filters.status "return" }}selected{{/ifCond}}>ƒêang ho√†n
                                h√†ng
                            </option>
                            <option value="returned" {{#ifCond filters.status "returned" }}selected{{/ifCond}}>ƒê√£ ho√†n
                                h√†ng
                            </option>
                            <option value="return_fail" {{#ifCond filters.status "return_fail" }}selected{{/ifCond}}>
                                Ho√†n
                                h√†ng th·∫•t
                                b·∫°i</option>
                            <option value="cancel_request" {{#ifCond filters.status "cancel_request"
                                }}selected{{/ifCond}}>
                                Y√™u c·∫ßu
                                h·ªßy</option>
                            <option value="canceled" {{#ifCond filters.status "canceled" }}selected{{/ifCond}}>ƒê√£ h·ªßy
                            </option>
                            <option value="rejected" {{#ifCond filters.status "rejected" }}selected{{/ifCond}}>T·ª´ ch·ªëi
                                x√°c
                                nh·∫≠n
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterPaymentStatus" class="form-label">Tr·∫°ng th√°i thanh to√°n</label>
                        <select id="filterPaymentStatus" class="form-select" name="payment_status">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="pending" {{#ifCond filters.payment_status "pending" }}selected{{/ifCond}}>Ch·ªù
                                thanh to√°n</option>
                            <option value="paid" {{#ifCond filters.payment_status "paid" }}selected{{/ifCond}}>ƒê√£ thanh
                                to√°n
                            </option>
                            <option value="refunded" {{#ifCond filters.payment_status "refunded" }}selected{{/ifCond}}>
                                Ho√†n
                                ti·ªÅn</option>
                        </select>
                    </div>
                </div>
                <div class="row align-items-end mt-3">
                    <div class="col-md-2">
                        <label for="timePeriod" class="form-label">Kho·∫£ng th·ªùi gian</label>
                        <select name="timePeriod" id="timePeriod" class="form-select">
                            <option value="" {{#unless filters.timePeriod}}selected{{/unless}}>T·∫•t c·∫£</option>
                            <option value="today" {{#if (eq filters.timePeriod "today" )}}selected{{/if}}>H√¥m nay
                            </option>
                            <option value="last_week" {{#if (eq filters.timePeriod "last_week" )}}selected{{/if}}>Tu·∫ßn
                                tr∆∞·ªõc
                            </option>
                            <option value="this_month" {{#if (eq filters.timePeriod "this_month" )}}selected{{/if}}>
                                Th√°ng n√†y
                            </option>
                            <option value="last_month" {{#if (eq filters.timePeriod "last_month" )}}selected{{/if}}>
                                Th√°ng tr∆∞·ªõc
                            </option>
                            <option value="last_3_months" {{#if (eq filters.timePeriod "last_3_months"
                                )}}selected{{/if}}>3
                                th√°ng g·∫ßn nh·∫•t</option>
                            <option value="custom_order" {{#if (eq filters.timePeriod "custom_order" )}}selected{{/if}}>
                                T√πy
                                ch·ªânh ng√†y ƒë·∫∑t h√†ng</option>
                            <option value="custom_delivery" {{#if (eq filters.timePeriod "custom_delivery"
                                )}}selected{{/if}}>
                                T√πy ch·ªânh ng√†y nh·∫≠n h√†ng</option>
                        </select>
                    </div>

                    <div class="col-md-2 custom-date-field" style="display: none;" id="startDate">
                        <label class="form-label">T·ª´ ng√†y</label>
                        <input type="date" class="form-control" name="startDate" value="{{filters.startDate}}">
                    </div>

                    <div class="col-md-2 custom-date-field" style="display: none;" id="endDate">
                        <label class="form-label">ƒê·∫øn ng√†y</label>
                        <input type="date" class="form-control" name="endDate" value="{{filters.endDate}}">
                    </div>

                    <div class="col-md-2 text-center">
                        <input type="checkbox" id="priceFilterCheckbox" {{#if filters.min_price}}checked{{/if}}>
                        <label for="priceFilterCheckbox" class="form-label">L·ªçc theo t·ªïng ti·ªÅn</label>
                    </div>
                    <div class="col-md-2 price-filter-fields" style="display: none">
                        <label for="minPrice" class="form-label">Gi√° t·ª´: <span id="minPriceLabel">0 VND</span></label>
                        <input type="number" class="form-control" name="min_price" id="minPrice"
                            value="{{filters.min_price}}">
                    </div>

                    <div class="col-md-2 price-filter-fields" style="display: none">
                        <label for="maxPrice" class="form-label">ƒê·∫øn: <span id="maxPriceLabel">0 VND</span></label>
                        <input type="number" class="form-control" name="max_price" id="maxPrice"
                            value="{{filters.max_price}}">
                    </div>

                </div>
                <div class="row align-items-end mt-3">
                    <div class="col-md-1">
                        <label class="form-label">Hi·ªÉn th·ªã</label>
                        <select class="form-select" name="limit">
                            <option value="10" {{#if (eq limit 10 )}}selected{{/if}}>10</option>
                            <option value="20" {{#if (eq limit 20 )}}selected{{/if}}>20</option>
                            <option value="50" {{#if (eq limit 50 )}}selected{{/if}}>50</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button id="btnSearchOrder" class="btn btn-primary w-100">L·ªçc</button>
                    </div>
                    <div class="col-md-1">
                        <button type="button" id="btnResetFilter" class="btn btn-secondary w-100">Reset</button>
                    </div>
                </div>

            </form>
        </div>
    </div>


    <table class="table table-striped">
        <thead>
            <tr>
                <th>M√£ v·∫≠n ƒë∆°n</th>
                <th>Kh√°ch h√†ng</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y ƒë·∫∑t</th>
                <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            {{#each orders}}
            <tr>
                <td>
                    {{#if this.order_code}}
                    #{{this.order_code}}
                    {{else}}
                    <span class="text-muted">Ch∆∞a c√≥ m√£</span>
                    {{/if}}
                </td>
                <td>{{this.to_name}}</td>
                <td>{{formatPrice this.total_price}} VND</td>
                <td>
                    <span class="badge {{getStatusClass this.status}}">{{getStatusText this.status}}</span>
                    {{#if (and this.cancel_request (neq this.status "canceled"))}}
                    <span class="badge bg-warning text-dark ms-2">Y√™u c·∫ßu h·ªßy ƒë∆°n</span>
                    {{/if}}

                </td>


                <td class="date-format" data-created-at="{{this.created_at}}">{{this.created_at}}</td>
                <td>
                    <span class="badge {{getPaymentClass this.payment_method}}">{{this.payment_method}}</span>
                    {{#if (eq this.payment_method "ONLINE")}}
                    {{#if (eq this.payment_status "paid")}}
                    <span class="badge bg-success ms-2">ƒê√£ thanh to√°n</span>
                    {{else if (eq this.payment_status "refunded")}}
                    {{!-- <span class="badge bg-warning text-dark mt-1">ƒê√£ ho√†n ti·ªÅn</span> --}}
                    <span class="badge bg-info ms-2">ƒê√£ ho√†n ti·ªÅn</span>
                    {{else}}
                    <span class="badge bg-danger ms-2">Ch∆∞a thanh to√°n</span>
                    {{/if}}
                    {{/if}}
                </td>
                <td><a href="/orders/{{this._id}}/detail" class="btn btn-primary btn-sm">Chi ti·∫øt</a></td>

            </tr>
            {{/each}}
        </tbody>
    </table>
    {{#unless orders.length}}
    <div class="text-center text-muted py-3">
        <i class="bi bi-search display-6 d-block mb-2"></i>
        <h5>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o ph√π h·ª£p</h5>
        <p>H√£y th·ª≠ ƒëi·ªÅu ch·ªânh t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc.</p>
    </div>
    {{/unless}}
    {{!-- <nav>
        <ul class="pagination justify-content-center">
            {{#if (gt currentPage 1)}}
            <li class="page-item">
                <a class="page-link" href="?page={{sub currentPage 1}}&limit={{limit}}">Trang tr∆∞·ªõc</a>
            </li>
            {{/if}}

            <li class="page-item disabled">
                <span class="page-link">Trang {{currentPage}} / {{totalPages}}</span>
            </li>

            {{#if (lt currentPage totalPages)}}
            <li class="page-item">
                <a class="page-link" href="?page={{add currentPage 1}}&limit={{limit}}">Trang sau</a>
            </li>
            {{/if}}
        </ul>
    </nav> --}}
    <nav>
        <ul class="pagination justify-content-center">
            {{#if (gt currentPage 1)}}
            <li class="page-item">
                <a class="page-link" href="javascript:void(0);" onclick="goToPage({{sub currentPage 1}})">Trang
                    tr∆∞·ªõc</a>
            </li>
            {{/if}}

            <li class="page-item disabled">
                <span class="page-link">Trang {{currentPage}} / {{totalPages}}</span>
            </li>

            {{#if (lt currentPage totalPages)}}
            <li class="page-item">
                <a class="page-link" href="javascript:void(0);" onclick="goToPage({{add currentPage 1}})">Trang sau</a>
            </li>
            {{/if}}
        </ul>
    </nav>
</div>
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastMessage" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">
                <!-- Message will be inserted here -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
    function goToPage(newPage) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', newPage);
        window.location.href = url.toString();
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        formatDates();


        const socket = io();
        socket.on("new_order", function (order) {
            showToast("üì¢ B·∫°n v·ª´a c√≥ m·ªôt ƒë∆°n h√†ng m·ªõi!", "bg-info");
        });
        socket.on("cancel_request", function (order) {
            showToast("‚ö†Ô∏è C√≥ y√™u c·∫ßu h·ªßy ƒë∆°n h√†ng!", "bg-warning");
        });

        socket.on("return_request", function (order) {
            showToast("üîÑ C√≥ y√™u c·∫ßu tr·∫£ h√†ng!", "bg-danger");
        });

        function formatDates() {
            document.querySelectorAll(".date-format").forEach(element => {
                const timestamp = element.dataset.createdAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    element.innerText = date.toLocaleString("vi-VN", {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                        hour: "2-digit",
                        minute: "2-digit",
                        hour12: false
                    });
                }
            });
        }

        function showToast(message, bgClass = "bg-success") {
            const toastElement = document.getElementById("toastMessage");
            const toastBody = document.getElementById("toastBody");

            toastBody.textContent = message;
            toastElement.classList.remove("bg-success", "bg-danger");
            toastElement.classList.add(bgClass);

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
        const form = document.getElementById("filterForm");
        const minPriceInput = document.getElementById("minPrice");
        const maxPriceInput = document.getElementById("maxPrice");
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        form.addEventListener("submit", function (e) {
            const minPrice = minPriceInput.value.trim();
            const maxPrice = maxPriceInput.value.trim();
            const startDate = startDateInput?.value;
            const endDate = endDateInput?.value;


            if (minPrice && Number(minPrice) < 0) {
                e.preventDefault();
                showToast("Gi√° t·ªëi thi·ªÉu ph·∫£i l√† s·ªë d∆∞∆°ng.", "bg-danger");
                return;
            }

            if (maxPrice && Number(maxPrice) < 0) {
                e.preventDefault();
                showToast("Gi√° t·ªëi ƒëa ph·∫£i l√† s·ªë d∆∞∆°ng.", "bg-danger");
                return;
            }

            if (minPrice && maxPrice && Number(minPrice) >= Number(maxPrice)) {
                e.preventDefault();
                showToast("Vui l√≤ng nh·∫≠p gi√° t·ªëi ƒëa l·ªõn h∆°n gi√° t·ªëi thi·ªÉu.", "bg-danger");
                return;
            }

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                e.preventDefault();
                showToast("Vui l√≤ng ch·ªçn ng√†y k·∫øt th√∫c l·ªõn h∆°n ng√†y b·∫Øt ƒë·∫ßu.", "bg-danger");
                return;
            }
        });
    });

</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById("toggleFilter");
        const filterCard = document.getElementById("filterCard");

        toggleBtn.addEventListener("click", function () {
            filterCard.style.display =
                filterCard.style.display === "none" ? "block" : "none";
        });
        const timeSelect = document.getElementById('timePeriod');
        const customFields = document.querySelectorAll('.custom-date-field');

        function toggleCustomDates() {
            const isCustom = timeSelect.value === 'custom';
            customFields.forEach(el => {
                el.style.display = isCustom ? 'block' : 'none';
            });
        }

        toggleCustomDates();
        timeSelect.addEventListener('change', toggleCustomDates);
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const timePeriodSelect = document.getElementById("timePeriod");
        const customDateFields = document.querySelectorAll(".custom-date-field");

        function toggleCustomDateFields() {
            const value = timePeriodSelect.value;
            if (value === "custom_order" || value === "custom_delivery") {
                customDateFields.forEach(el => el.style.display = "block");
            } else {
                customDateFields.forEach(el => el.style.display = "none");
            }
        }

        timePeriodSelect.addEventListener("change", toggleCustomDateFields);
        toggleCustomDateFields();
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        function formatCurrency(value) {
            if (!value) return '0 VND';
            return parseInt(value).toLocaleString('vi-VN') + ' VND';
        }

        const minPriceInput = document.getElementById('minPrice');
        const maxPriceInput = document.getElementById('maxPrice');

        const minPriceLabel = document.getElementById('minPriceLabel');
        const maxPriceLabel = document.getElementById('maxPriceLabel');

        minPriceInput.addEventListener('input', function () {
            const minPriceValue = minPriceInput.value;
            minPriceLabel.textContent = formatCurrency(minPriceValue);
        });

        maxPriceInput.addEventListener('input', function () {
            const maxPriceValue = maxPriceInput.value;
            maxPriceLabel.textContent = formatCurrency(maxPriceValue);
        });

        minPriceLabel.textContent = formatCurrency(minPriceInput.value);
        maxPriceLabel.textContent = formatCurrency(maxPriceInput.value);


        function togglePriceFilter() {
            var priceFields = document.querySelectorAll(".price-filter-fields");
            var checkbox = document.getElementById("priceFilterCheckbox");
            if (checkbox.checked) {
                priceFields.forEach(function (field) {
                    field.style.display = "block";
                });
            } else {
                priceFields.forEach(function (field) {
                    field.style.display = "none";
                });
            }
        }
        togglePriceFilter();
        document.getElementById("priceFilterCheckbox").addEventListener("change", togglePriceFilter);

    });
</script>

<script>
    const searchForm = document.getElementById('searchForm');
    const filterForm = document.getElementById('filterForm');

    searchForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const searchParams = new URLSearchParams(new FormData(searchForm));

        if (filterForm) {
            const filterParams = new FormData(filterForm);
            for (const [key, value] of filterParams.entries()) {
                if (!searchParams.has(key)) {
                    searchParams.append(key, value);
                }
            }
        }
        window.location.href = `?${searchParams.toString()}`;
    });

    filterForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const filterParams = new URLSearchParams(new FormData(filterForm));
        if (searchForm) {
            const searchValue = searchForm.querySelector('#searchOrder').value;
            if (searchValue) {
                filterParams.append('search', searchValue);
            }
        }
        window.location.href = `?${filterParams.toString()}`;
    });
</script>
<script>
    document.getElementById('btnResetFilter').addEventListener('click', function () {
        const form = document.getElementById('filterForm');
        form.reset();

        form.querySelectorAll('input[type="date"], input[type="number"]').forEach(input => input.value = '');
        form.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        document.querySelectorAll('.custom-date-field, .price-filter-fields').forEach(field => {
            field.style.display = 'none';
        });

        document.getElementById('priceFilterCheckbox').checked = false;

        //window.location.href = window.location.pathname;
    });
</script>
