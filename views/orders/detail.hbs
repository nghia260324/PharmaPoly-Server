<div class="container">
    <a href="" class="btn btn-secondary mb-4 mt-4" id="backBtn">
        <i class="bi bi-arrow-left-circle"></i> Quay l·∫°i
    </a>


    <h3 class="mb-4">Chi Ti·∫øt ƒê∆°n H√†ng #{{order.order_code}}</h3>

    <!-- Th√¥ng tin ƒë∆°n h√†ng -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Th√¥ng Tin ƒê∆°n H√†ng</h5>
            <br>
            <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> {{order.to_name}}</p>
            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{order.to_phone}}</p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> {{order.to_address}}, {{userAddress.ward.WardName}},
                {{userAddress.district.DistrictName}}, {{userAddress.province.ProvinceName}}</p>

            <p class="date-format" data-created-at="{{order.created_at}}"><strong>Ng√†y ƒë·∫∑t:</strong>
                {{order.created_at}}
            </p>
            {{!-- <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> <span
                    class="badge bg-primary">{{order.payment_method}}</span>
            </p> --}}
            <p>
                <strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong>
                <span class="badge bg-primary">{{order.payment_method}}</span>

                {{!-- {{#if (eq order.payment_method "ONLINE")}}
                {{#if (eq order.payment_status 'paid')}}
                <span class="badge bg-success">ƒê√£ thanh to√°n</span>
                {{else}}
                <span class="badge bg-danger">
                    Ch∆∞a thanh to√°n
                    <span id="countdown" class="fw-bold"></span>
                </span>
                {{/if}}
                {{/if}} --}}

                {{#if (or (eq order.payment_status "paid") (eq order.payment_status "refunded"))}}
                <span class="badge bg-success">ƒê√£ thanh to√°n</span>
                {{else}}
                <span class="badge bg-danger">
                    Ch∆∞a thanh to√°n
                    <span id="countdown" class="fw-bold"></span>
                </span>
                {{/if}}

            </p>

            <p><strong>T·ªïng ti·ªÅn:</strong> {{formatPrice order.total_price}} VND</p>
            {{!-- <p><strong>Tr·∫°ng th√°i:</strong>
                <span class="status-badge bg-warning">{{getStatusText order.status}}</span>
            </p> --}}
            <p><strong>Tr·∫°ng th√°i:</strong>
                <span class="status-badge bg-warning">{{getStatusText order.status}}</span>

                {{#if (eq order.payment_status "refunded")}}
                <span class="badge bg-info ms-2">ƒê√£ ho√†n ti·ªÅn</span>
                {{/if}}
            </p>

            {{!-- <div class="mt-3">
                {{#if (eq order.status "pending")}}
                <button class="btn btn-primary" onclick="confirmOrder('{{order._id}}')">X√°c nh·∫≠n ƒë∆°n h√†ng</button>
                <button class="btn btn-danger" onclick="rejectOrder('{{order._id}}')">T·ª´ ch·ªëi ƒë∆°n h√†ng</button>
                {{/if}}

                {{#if (eq order.status "confirmed")}}
                {{#if (eq order.payment_method "COD")}}
                <button class="btn btn-success" onclick="readyToShip('{{order._id}}')">S·∫µn s√†ng giao h√†ng</button>
                {{else}}
                {{#if (eq order.payment_status "paid")}}
                <button class="btn btn-success" onclick="readyToShip('{{order._id}}')">S·∫µn s√†ng giao h√†ng</button>
                {{else}}
                <p class="text-danger">‚ö† Kh√¥ng th·ªÉ chuy·ªÉn tr·∫°ng th√°i v√¨ ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c thanh to√°n.</p>
                {{/if}}
                {{/if}}
                {{/if}}

                {{#if (and (or (eq order.status "confirmed") (eq order.status "ready_to_pick")) order.cancel_request)}}
                <button class="btn btn-danger" onclick="approveCancel('{{order._id}}')">ƒê·ªìng √Ω h·ªßy ƒë∆°n</button>
                <button class="btn btn-secondary" onclick="rejectCancel('{{order._id}}')">T·ª´ ch·ªëi y√™u c·∫ßu h·ªßy</button>
                {{/if}}
            </div> --}}
            <div class="mt-3">
                {{#if (eq order.status "pending")}}
                <button class="btn btn-primary" onclick="confirmOrder('{{order._id}}')">X√°c nh·∫≠n ƒë∆°n h√†ng</button>
                <button class="btn btn-danger" onclick="rejectOrder('{{order._id}}')">T·ª´ ch·ªëi ƒë∆°n h√†ng</button>
                {{/if}}

                {{#if (eq order.status "confirmed")}}
                {{#if (eq order.payment_method "COD")}}
                <button class="btn btn-success" onclick="readyToShip('{{order._id}}')">S·∫µn s√†ng giao h√†ng</button>
                {{else}}
                {{#if (eq order.payment_status "paid")}}
                <button class="btn btn-success" onclick="readyToShip('{{order._id}}')">S·∫µn s√†ng giao h√†ng</button>
                {{else}}
                <p class="text-danger">‚ö† Kh√¥ng th·ªÉ chuy·ªÉn tr·∫°ng th√°i v√¨ ƒë∆°n h√†ng ch∆∞a ƒë∆∞·ª£c thanh to√°n.</p>
                {{/if}}
                {{/if}}
                {{/if}}

                {{#if (or
                (and (or (eq order.status "confirmed") (eq order.status "ready_to_pick")) order.cancel_request)
                (and (eq order.status "pending") (neq order.payment_method "COD") order.cancel_request)
                )}}
                <button class="btn btn-danger" onclick="approveCancel('{{order._id}}')">ƒê·ªìng √Ω h·ªßy ƒë∆°n</button>
                <button class="btn btn-secondary" onclick="rejectCancel('{{order._id}}')">T·ª´ ch·ªëi y√™u c·∫ßu h·ªßy</button>
                {{/if}}
            </div>


        </div>
    </div>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="card">
        <div class="card-body">
            <h5>Danh S√°ch S·∫£n Ph·∫©m</h5>
            <table class="table table-bordered mt-3">
                <thead class="table-light">
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 10%;">H√¨nh ·∫£nh</th>
                        <th style="width: 45%;">T√™n s·∫£n ph·∫©m</th>
                        <th style="width: 10%;">S·ªë l∆∞·ª£ng</th>
                        <th style="width: 15%;">Gi√°</th>
                        <th style="width: 15%;">T·ªïng</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each orderItems}}
                    <tr>
                        <td>{{addOne @index}}</td>
                        <td><img src="{{this.image_url}}" alt="H√¨nh ·∫£nh s·∫£n ph·∫©m" width="50"></td>
                        <td>{{this.product_product_type_id.product_id.name}}</td>
                        <td>{{this.quantity}}</td>
                        <td>{{formatPrice this.price}} VND</td>
                        <td>{{multiplyAndFormat this.quantity this.price}} VND</td>
                    </tr>
                    {{/each}}

                    <tr>
                        <td colspan="5" class="text-end"><strong>Ph√≠ v·∫≠n chuy·ªÉn</strong></td>
                        <td>{{formatPrice order.shipping_fee}} VND</td>
                    </tr>

                    <tr>
                        <td colspan="5" class="text-end"><strong>T·ªïng thanh to√°n</strong></td>
                        <td><strong>{{formatPrice order.total_price}} VND</strong></td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>
</div>
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastMessage" class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">
                <!-- Message will be inserted here -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>
<!-- Modal x√°c nh·∫≠n c·∫≠p nh·∫≠t tr·∫°ng th√°i -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">X√°c nh·∫≠n c·∫≠p nh·∫≠t tr·∫°ng th√°i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh <strong id="selectedStatusText"></strong>
                kh√¥ng?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmUpdateStatus">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
            </div>
            <p class="mt-2">ƒêang c·∫≠p nh·∫≠t tr·∫°ng th√°i, vui l√≤ng ch·ªù...</p>
        </div>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<!-- Modal Ho√†n Ti·ªÅn -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refundModalLabel">Qu√©t QR ƒë·ªÉ ho√†n ti·ªÅn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <img id="qrCodeImage" src="" alt="QR Ho√†n Ti·ªÅn" class="img-fluid">
                    {{!-- <p class="text-muted">S·ªë ti·ªÅn: {{formatPrice order.total_price}} VND</p> --}}
                </div>
                <div id="loadingQr" class="d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">ƒêang t·∫°o QR code...</p>
                </div>
            </div>
            {{!-- <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="confirmRefund">ƒê√£ ho√†n ti·ªÅn</button>
            </div> --}}
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('backBtn').addEventListener('click', function (e) {
            e.preventDefault();

            window.history.go(-1);
        });
        const socket = io();
        socket.on("new_order", function (order) {
            showToast("üì¢ B·∫°n v·ª´a c√≥ m·ªôt ƒë∆°n h√†ng m·ªõi!", "bg-info");
        });
        socket.on("cancel_request", function (order) {
            showToast("‚ö†Ô∏è C√≥ y√™u c·∫ßu h·ªßy ƒë∆°n h√†ng!", "bg-warning");
        });

        //socket.on("return_request", function (order) {
        //showToast("üîÑ C√≥ y√™u c·∫ßu tr·∫£ h√†ng!", "bg-danger");
        //});

        formatDates();
        startCountdown();
    });
    function openConfirmModal(statusText, callback) {
        document.getElementById("selectedStatusText").textContent = statusText;
        const confirmButton = document.getElementById("confirmUpdateStatus");

        confirmButton.replaceWith(confirmButton.cloneNode(true));
        document.getElementById("confirmUpdateStatus").addEventListener("click", function () {
            callback();
            const modal = bootstrap.Modal.getInstance(document.getElementById("confirmModal"));
            modal.hide();
        });

        new bootstrap.Modal(document.getElementById("confirmModal")).show();
    }
    function sendRequest(url, method = "POST", body = null) {
        const options = {
            method,
            headers: { "Content-Type": "application/json" }
        };

        if (body) options.body = JSON.stringify(body);

        fetch(url, options)
            .then(response => response.json())
            .then(data => {
                if (data.status == 200) {
                    showToast("Th√†nh c√¥ng!", "bg-success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast("L·ªói: " + data.message, "bg-danger");
                }
            })
            .catch(error => {
                console.error("L·ªói:", error);
                showToast("ƒê√£ x·∫£y ra l·ªói.", "bg-danger");
            });
    }
    function rejectOrder(orderId) {
        openConfirmModal("T·ª´ ch·ªëi ƒë∆°n h√†ng", () => sendRequest(`/orders/${orderId}/reject`, 'PUT'));
    }

    function confirmOrder(orderId) {
        openConfirmModal("X√°c nh·∫≠n ƒë∆°n h√†ng", () => sendRequest(`/orders/${orderId}/confirm`, 'PUT'));
    }

    function readyToShip(orderId) {
        openConfirmModal("S·∫µn s√†ng giao h√†ng", () => sendRequest(`/orders/${orderId}/send-to-ghn`, 'PUT'));
    }

    //function approveCancel(orderId) {
    //openConfirmModal("ƒê·ªìng √Ω h·ªßy ƒë∆°n", () => sendRequest(`/orders/${orderId}/cancel`, "POST", { action: "accept" }));
    //}
    function approveCancel(orderId) {
        const isOnlinePaid = "{{order.payment_method}}" === "ONLINE" && "{{order.payment_status}}" === "paid";

        if (isOnlinePaid) {
            showRefundModal(orderId);
        } else {
            openConfirmModal("ƒê·ªìng √Ω h·ªßy ƒë∆°n", () => sendRequest(`/orders/${orderId}/cancel`, "POST", { action: "accept" }));
        }
    }

    function rejectCancel(orderId) {
        openConfirmModal("T·ª´ ch·ªëi y√™u c·∫ßu h·ªßy", () => sendRequest(`/orders/${orderId}/cancel`, "POST", { action: "reject" }));
    }

    function showRefundModal(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('refundModal'));
        const qrImage = document.getElementById('qrCodeImage');
        const loading = document.getElementById('loadingQr');

        loading.classList.remove('d-none');
        qrImage.style.display = 'none';

        fetch(`/orders/${orderId}/refund-qr`)
            .then(response => response.json())
            .then(data => {
                if (data.qrLink) {
                    qrImage.src = data.qrLink;  // ƒê·∫∑t link QR code v√†o img src
                    loading.classList.add('d-none');  // ·∫®n loading spinner
                    qrImage.style.display = 'block';  // Hi·ªÉn th·ªã QR code
                    checkOrderStatus(orderId);
                }
            })
            .catch(error => {
                console.error('L·ªói khi l·∫•y QR code:', error);
                showToast("L·ªói khi t·∫°o QR ho√†n ti·ªÅn", "bg-danger");
                modal.hide();  // ƒê√≥ng modal n·∫øu c√≥ l·ªói
            });

        modal.show();
    }

    function startCountdown() {
        const countdownElement = document.getElementById("countdown");
        if (!countdownElement) return;

        const createdAt = new Date("{{order.created_at}}"); // L·∫•y th·ªùi gian t·∫°o ƒë∆°n
        const expireTime = new Date(createdAt.getTime() + 10 * 60000); // H·∫øt h·∫°n sau 10 ph√∫t

        function updateCountdown() {
            const now = new Date();
            const diff = Math.max(0, Math.floor((expireTime - now) / 1000)); // S·ªë gi√¢y c√≤n l·∫°i
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;

            if (diff > 0) {
                countdownElement.textContent = ` (H·ªßy sau: ${minutes} ph√∫t ${seconds} gi√¢y)`;
            } else {
                countdownElement.textContent = " (ƒê∆°n h√†ng ƒë√£ h·∫øt h·∫°n)";
                countdownElement.classList.remove("text-danger");
                countdownElement.classList.add("text-muted");
            }
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    }
    function formatDates() {
        document.querySelectorAll(".date-format").forEach(element => {
            const timestamp = element.dataset.createdAt;
            if (timestamp) {
                const date = new Date(timestamp);
                const formattedDate = date.toLocaleString("vi-VN", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: false
                });
                element.innerHTML = `<strong>Ng√†y ƒë·∫∑t:</strong> ${formattedDate}`;
            }
        });
    }
    let statusIntervalId = null;

    function checkOrderStatus(orderId) {
        statusIntervalId = setInterval(() => {
            fetch(`/orders/payment_status/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 200) {
                        clearInterval(statusIntervalId);
                        closeQrModal();

                        showToast("Ho√†n ti·ªÅn th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy.", "bg-success");
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error("L·ªói khi g·ªçi API:", error);
                });
        }, 10000);
    }

    function closeQrModal() {
        const refundModal = bootstrap.Modal.getInstance(document.getElementById("refundModal"));
        if (refundModal) {
            refundModal.hide();
        }
    }

    function showToast(message, bgClass = "bg-success") {
        const toastElement = document.getElementById("toastMessage");
        const toastBody = document.getElementById("toastBody");

        toastBody.textContent = message;
        toastElement.classList.remove("bg-success", "bg-danger");
        toastElement.classList.add(bgClass);

        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }
</script>