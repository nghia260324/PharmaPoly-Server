

// var app = require('../app');
// var debug = require('debug')('ung-dung-mua-thuoc-truc-tuyen-pharmapoly:server');
// var https = require('https');
// var fs = require('fs');
// var path = require('path');

// /**
//  * Get port from environment and store in Express.
//  */

// var port = normalizePort(process.env.PORT || '443');
// app.set('port', port);

// /**
//  * Äá»c chá»©ng chá»‰ SSL
//  */

// var sslOptions = {
//   key: fs.readFileSync(path.join(__dirname, '../server.key')),
//   cert: fs.readFileSync(path.join(__dirname, '../server.cert'))
// };

// /**
//  * Create HTTPS server.
//  */

// var server = https.createServer(sslOptions, app);

// /**
//  * Listen on provided port, on all network interfaces.
//  */

// //server.listen(port);
// //server.listen(port, 'pharmapoly');
// server.listen(port, '0.0.0.0'); // Hoáº·c '127.0.0.1' náº¿u chá»‰ cháº¡y local

// server.on('error', onError);
// server.on('listening', onListening);

// /**
//  * Normalize a port into a number, string, or false.
//  */

// function normalizePort(val) {
//   var port = parseInt(val, 10);

//   if (isNaN(port)) {
//     return val;
//   }

//   if (port >= 0) {
//     return port;
//   }

//   return false;
// }

// /**
//  * Event listener for HTTPS server "error" event.
//  */

// function onError(error) {
//   if (error.syscall !== 'listen') {
//     throw error;
//   }

//   var bind = typeof port === 'string'
//     ? 'Pipe ' + port
//     : 'Port ' + port;

//   switch (error.code) {
//     case 'EACCES':
//       console.error(bind + ' requires elevated privileges');
//       process.exit(1);
//       break;
//     case 'EADDRINUSE':
//       console.error(bind + ' is already in use');
//       process.exit(1);
//       break;
//     default:
//       throw error;
//   }
// }

// /**
//  * Event listener for HTTPS server "listening" event.
//  */

// function onListening() {
//   var addr = server.address();
//   var bind = typeof addr === 'string'
//     ? 'pipe ' + addr
//     : 'port ' + addr.port;
//   debug('Listening on ' + bind);
//   console.log(`Server running at https://localhost`);
// }


var app = require('../app');
var debug = require('debug')('ung-dung-mua-thuoc-truc-tuyen-pharmapoly:server');
var http = require('http');
const socketIo = require('socket.io');
const Chats = require('../models/chats');
/**
 * Get port from environment and store in Express.
 */
var port = normalizePort(process.env.PORT || '3000'); // KhÃ´ng dÃ¹ng 443
app.set('port', port);

/**
 * Create HTTP server (Render tá»± cáº¥p SSL).
 */
var server = http.createServer(app);
//const io = socketIo(server);
const io = socketIo(server, {
  cors: {
    origin: "*", // Cho phÃ©p truy cáº­p tá»« má»i nÆ¡i (cÃ³ thá»ƒ thay báº±ng domain cá»¥ thá»ƒ)
    methods: ["GET", "POST"]
  }
});
app.set('io', io); 



let users = {}

io.on("connection", async (socket) => {
  console.log("Socket query:", socket.handshake.query);

  // xá»­ lÃ½ káº¿t ná»‘i cá»§a ngÆ°á»i dÃ¹ng
  const userId = socket.handshake.query.userId; 
  console.log("ðŸ” userId nháº­n Ä‘Æ°á»£c:", userId);
  if (!userId) {
    console.log(" Káº¿t ná»‘i tháº¥t báº¡i: KhÃ´ng cÃ³ userId");
    socket.disconnect();
    return;
  }

  users[userId] = socket.id;
  console.log(`${userId} Ä‘Ã£ káº¿t ná»‘i vá»›i socket ID: ${socket.id}`);

  const chat = await Chats.findOne(
    { user_id: userId },
    { _id: 0, "fullChat._id": 0 }
  );
  socket.emit("oldMessages", chat ? chat.fullChat : []);

  // xá»­ lÃ½ user gá»­i tin nháº¯n
  socket.on("sendMessage", async ({ senderId, receiverId, message }) => {
    console.log(`ðŸ“© Tin nháº¯n tá»« ${senderId} Ä‘áº¿n ${receiverId}: ${message}`);

    if (!message.trim()) return;

    const newMessage = {
      message,
      senderId: senderId,
      timestamp: new Date(),
    };

    let chat = await Chats.findOne({ user_id: senderId });
    if (!chat) {
      chat = new Chats({
        user_id: senderId,
        lastMessage: message,
        timeSentLastMessage: new Date(),
        sentBy: senderId,
        fullChat: [newMessage],
      });
    } else {
      chat.fullChat.push(newMessage);
      chat.lastMessage = message;
      chat.timeSentLastMessage = new Date();
      chat.sentBy = senderId;
    }

    await chat.save();

    // Gá»­i pháº£n há»“i vá» user gá»­i tin nháº¯n
    socket.emit("messageSentSuccess", { status: "success", message: "Tin nháº¯n gá»­i thÃ nh cÃ´ng!", data: newMessage });

    // Gá»­i tin nháº¯n má»›i Ä‘áº¿n admin náº¿u Ä‘ang online
    if (users[receiverId]) {
      io.to(users[receiverId]).emit("receiveMessage", { status: "success", message: "Tin nháº¯n gá»­i thÃ nh cÃ´ng!", data: newMessage });
    }
  });

  // xá»­ lÃ½ user gá»­i tin nháº¯n admin
  socket.on("sendMessageByAdmin", async ({ adminId, userId, message }) => {
    console.log(`ðŸ“© Tin nháº¯n tá»« ${adminId} Ä‘áº¿n ${userId}: ${message}`);

    if (!message.trim()) return;

    const newMessage = {
      message,
      senderId: adminId,
      timestamp: new Date(),
    };

    let chat = await Chats.findOne({ user_id: userId });
    if (!chat) {
      chat = new Chats({
        user_id: userId,
        lastMessage: message,
        timeSentLastMessage: new Date(),
        sentBy: adminId,
        fullChat: [newMessage],
      });
    } else {
      chat.fullChat.push(newMessage);
      chat.lastMessage = message;
      chat.timeSentLastMessage = new Date();
      chat.sentBy = adminId;
    }

    await chat.save();

    socket.emit("messageSentSuccess", { status: "success", message: "Tin nháº¯n gá»­i thÃ nh cÃ´ng!", data: newMessage });

    if (users[userId]) {
      io.to(users[userId]).emit("receiveMessage", { status: "success", message: "Tin nháº¯n gá»­i thÃ nh cÃ´ng!", data: newMessage });
    }
  });

  socket.on("disconnect", () => {
    console.log("User disconnected:", socket.id);
    for (let userId in users) {
      if (users[userId] === socket.id) {
        delete users[userId];
        break;
      }
    }
  });
});

/**
 * Listen on provided port, on all network interfaces.
 */
server.listen(port, '0.0.0.0'); // Cho phÃ©p truy cáº­p tá»« má»i nÆ¡i
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */
function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */
function onError(error) {
  if (error.syscall !== 'listen') throw error;
  var bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */
function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string' ? 'pipe ' + addr : 'port ' + addr.port;
  debug('Listening on ' + bind);
  console.log(`Server running at http://0.0.0.0:${port}`);
}
